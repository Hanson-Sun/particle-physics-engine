<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\utils\InputHandler.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\utils\InputHandler.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
const Particle = require(&quot;../core/Particle&quot;);
const Vector2D = require(&quot;./Vector2D&quot;);
const ForcePivotConstraint = require(&quot;../constraints/ForcePivotConstraint&quot;);

/**
 * Will only work inside a website --&gt; Node version wont work.
 */
class InputHandler {
    constructor(world, enableMouseInteractions=true) {
        this.world = world;
        this.canvas = world.canvas;

        this.mouseFocusElement = this.canvas;
        this.keyFocusElement = window;

        this.mouseDownPosition = new Vector2D(0,0);
        this.mousePosition = new Vector2D(0,0);
        this.mouseIsDown = false;

        this.keyPress = null;

        this.selectedParticle = null;
        this.currentlySelectedParticle = null;
        this.particleConstraint = null;

        this.keyEvents = [];

        this.minSelectRadius = 20;

        this.enableMouseInteractions = enableMouseInteractions;

        this.mouseDownFunction = () =&gt; {};
        this.mouseUpFunction = () =&gt; {}
    }

    static KeyInput = class KeyInput {
        constructor(keyCode, func, isMouseDown=false) {
            this.keyCode = keyCode || &quot;&quot;;
            this.func = func || (() =&gt; {});
            this.isMouseDown = isMouseDown;
        }
    }

    getMousePos(event, handler) {
        const rect = handler.canvas.getBoundingClientRect();
        return new Vector2D(event.clientX - rect.left, event.clientY - rect.top);
    }

    startMouseHandling() {
        this.mouseFocusElement.addEventListener(&quot;mousedown&quot;, (event) =&gt; {this.mousedown(event, this)});
        this.mouseFocusElement.addEventListener(&quot;mousemove&quot;, (event) =&gt; {this.mousemove(event, this)});
        window.addEventListener(&quot;mouseup&quot;, (event) =&gt; {this.mouseup(event, this)});
    }

    startKeyHandling() {
        // this is cursed as hell...
        this.keyFocusElement.addEventListener(&quot;keydown&quot;, (event)  =&gt; {this.keyDown(event, this)});   
        this.keyFocusElement.addEventListener(&quot;keyup&quot;, (event) =&gt; {this.keyUp(event, this)});
    }

    mousedown(event, handler) {
        handler.mousePosition = handler.getMousePos(event, handler);
        handler.mouseDownPosition = handler.getMousePos(event, handler);
        handler.mouseIsDown = true;
        handler.findSelectedParticle(handler);

        if (handler.currentlySelectedParticle !== null &amp;&amp; handler.enableMouseInteractions) {
            handler.createConstraint(handler);
        }

        handler.mouseDownFunction();
    }

    mousemove(event, handler) {
        handler.mousePosition = handler.getMousePos(event, handler);
        if (handler.particleConstraint) {
            handler.particleConstraint.pos = handler.mousePosition;
        }
    }

    mouseup(event, handler) {
        handler.mouseIsDown = false;
        handler.currentlySelectedParticle = null;
        handler.removeConstraint(handler);
        handler.mouseUpFunction();
    }

    findSelectedParticle(handler) {
        const zero = new Vector2D(0,0);
        const testParticle = new Particle(handler.mouseDownPosition, zero, 1, 10);
        let min = Infinity;
        let minParticle = null;

        for (let particle of handler.world.particles.findNear(testParticle)) {
            const dist = particle.pos.sub(handler.mouseDownPosition).mag()
            if (dist&lt;= particle.radius) {
                handler.selectedParticle = particle;
                handler.currentlySelectedParticle = particle;
                return;
            }else if (dist &lt;= handler.minSelectRadius &amp;&amp; dist &lt; min) {
                min = dist;
                minParticle = particle;
            }   
        }

        if (minParticle !== null) {
            handler.selectedParticle = minParticle;
            handler.currentlySelectedParticle = minParticle;
        }
    }

    createConstraint(handler) {
        //let stiffness = handler.currentlySelectedParticle.mass * 50;
        //handler.particleConstraint = new ForcePivotConstraint(handler.mousePosition, handler.currentlySelectedParticle, 0, stiffness, stiffness/5);
        handler.particleConstraint = new PositionPivotConstraint(handler.mousePosition, handler.currentlySelectedParticle, 0, 
            0.8 / handler.world.iterationPerFrame / handler.world.iterationPerFrame);
        handler.world.addConstraint(handler.particleConstraint);
    }

    removeConstraint(handler) {
        if (handler.particleConstraint !== null) {
            handler.world.removeConstraint(handler.particleConstraint);
            handler.particleConstraint = null;
        }
    }

    keyDown(event, handler) {
        const key = event.key;
        for (let keyInput of handler.keyEvents) {
            if (keyInput.isMouseDown) {
                if (key === keyInput.keyCode &amp;&amp; handler.mouseIsDown) {
                    handler.keyPress = key;
                    keyInput.func();
                }
            } else {
                if (key === keyInput.keyCode) {
                    handler.keyPress = key;
                    keyInput.func();
                }
            }
        }
    }

    keyUp(event, handler) {
        handler.keyPress = null
    }

    addKeyEvent(keyInput) {
        this.keyEvents.push(keyInput);
    }
}

module.exports = InputHandler;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
